# Visual Diagrams: TTS Queue Implementation

## Before vs After

### BEFORE (Broken) âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Main Thread (GUI + Coordinator)    â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ GUI shows red light: "Ready"     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ User clicks button                â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ Wake word detected (Porcupine)    â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ Speech recorded (Whisper STT)     â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ Intent detected                   â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ LLM generates response            â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ Call sink.speak("Hello")          â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ TTS tries asyncio.create_task()   â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ âš ï¸  RuntimeError! âš ï¸               â”‚  â”‚
â”‚  â”‚ "No current event loop            â”‚  â”‚
â”‚  â”‚  in thread 'Thread-1'"            â”‚  â”‚
â”‚  â”‚  â†“                                â”‚  â”‚
â”‚  â”‚ GUI freezes, audio never plays    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER (Fixed) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Main Thread (GUI + Coordinator)       â”‚
â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GUI shows red light: "Ready"         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ User clicks button                   â”‚ â”‚
â”‚  â”‚  â†“                                   â”‚ â”‚
â”‚  â”‚ Wake word detected (Porcupine)       â”‚ â”‚
â”‚  â”‚  â†“                                   â”‚ â”‚
â”‚  â”‚ Speech recorded (Whisper STT)        â”‚ â”‚
â”‚  â”‚  â†“                                   â”‚ â”‚
â”‚  â”‚ Intent detected                      â”‚ â”‚
â”‚  â”‚  â†“                                   â”‚ â”‚
â”‚  â”‚ LLM generates response               â”‚ â”‚
â”‚  â”‚  â†“                                   â”‚ â”‚
â”‚  â”‚ Call sink.speak("Hello")             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Split: ["Hello"]                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Queue.put("Hello") [<1ms]       â”‚ â”‚
â”‚  â”‚  â””â”€ Return immediately! âœ“            â”‚ â”‚
â”‚  â”‚  â†“                                   â”‚ â”‚
â”‚  â”‚ Continue listening for next audio    â”‚ â”‚
â”‚  â”‚ (LLM can continue generating)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ queue.Queue (thread-safe)
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Thread (Piper + Audio)             â”‚
â”‚                                           â”‚
â”‚  _worker() loop:                         â”‚
â”‚    1. item = queue.get(timeout=0.5)      â”‚
â”‚    2. if item is None: break (poison pill)â”‚
â”‚    3. _play_sentence(item)                â”‚
â”‚       â”œâ”€ Create Piper subprocess         â”‚
â”‚       â”œâ”€ Read audio from Piper stdout    â”‚
â”‚       â””â”€ Play via sounddevice.play()     â”‚
â”‚    4. Loop back to step 1                â”‚
â”‚                                           â”‚
â”‚  [Audio playing...] ğŸ”Š                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Detailed Flow: Queue-Based TTS

### Step 1: LLM Generates Text

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM (Main Thread)              â”‚
â”‚  Response: "Hello. World. Yes." â”‚
â”‚                                 â”‚
â”‚  sink.send("Hello. World. Yes.")â”‚
â”‚  â””â”€ Return IMMEDIATELY          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
```

### Step 2: Text Split Into Sentences

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Regex Sentence Splitter        â”‚
â”‚                                 â”‚
â”‚  re.split(r'(?<=[.!?])\s+',    â”‚
â”‚    "Hello. World. Yes.")       â”‚
â”‚                                 â”‚
â”‚  Result:                        â”‚
â”‚  â”œâ”€ "Hello"                    â”‚
â”‚  â”œâ”€ "World"                    â”‚
â”‚  â””â”€ "Yes."                     â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
```

### Step 3: Sentences Queued

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  queue.Queue (Thread-Safe)           â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [0] "Hello"                    â”‚ â”‚
â”‚  â”‚ [1] "World"                    â”‚ â”‚
â”‚  â”‚ [2] "Yes."                     â”‚ â”‚
â”‚  â”‚ [3] None â˜ ï¸ (poison pill)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚  Main thread continues:              â”‚
â”‚  - Can listen for next wake word    â”‚
â”‚  - Can process next user input      â”‚
â”‚  - Can update GUI                   â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
```

### Step 4: Worker Thread Consumes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Thread Loop                              â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Iteration 1:                             â”‚   â”‚
â”‚  â”‚  item = queue.get(timeout=0.5)           â”‚   â”‚
â”‚  â”‚  if item is None: break                  â”‚   â”‚
â”‚  â”‚  â†’ Got "Hello"                           â”‚   â”‚
â”‚  â”‚  _play_sentence("Hello")                 â”‚   â”‚
â”‚  â”‚    â”œâ”€ Piper subprocess                   â”‚   â”‚
â”‚  â”‚    â”œâ”€ Read 4410 bytes (200ms of audio)   â”‚   â”‚
â”‚  â”‚    â””â”€ sounddevice.play()                 â”‚   â”‚
â”‚  â”‚    â†’ [Audio: "Hello"]                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Iteration 2:                             â”‚   â”‚
â”‚  â”‚  item = queue.get(timeout=0.5)           â”‚   â”‚
â”‚  â”‚  â†’ Got "World"                           â”‚   â”‚
â”‚  â”‚  _play_sentence("World")                 â”‚   â”‚
â”‚  â”‚    â†’ [Audio: "World"]                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Iteration 3:                             â”‚   â”‚
â”‚  â”‚  item = queue.get(timeout=0.5)           â”‚   â”‚
â”‚  â”‚  â†’ Got "Yes."                            â”‚   â”‚
â”‚  â”‚  _play_sentence("Yes.")                  â”‚   â”‚
â”‚  â”‚    â†’ [Audio: "Yes."]                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Iteration 4:                             â”‚   â”‚
â”‚  â”‚  item = queue.get(timeout=0.5)           â”‚   â”‚
â”‚  â”‚  â†’ Got None (poison pill)                â”‚   â”‚
â”‚  â”‚  break  [Exit worker thread]             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Threading Timeline

```
Time    Main Thread (GUI)          Worker Thread (Piper)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 0ms    â”Œâ”€ LLM generating...
        â”‚
 50ms   â”‚
        â”‚
100ms   â”œâ”€ LLM done! Call sink.send()
        â”‚  â””â”€ Queue "Hello"
        â”‚  â””â”€ Return immediately
        â”‚
150ms   â”œâ”€ Listen for next audio       â”Œâ”€ Get "Hello" from queue
        â”‚                              â”œâ”€ Create Piper subprocess
        â”‚                              â”œâ”€ Piper synthesizing...
200ms   â”‚                              â”‚
        â”‚                              â”œâ”€ Got 4410 bytes
        â”‚                              â”œâ”€ Play audio [0-100ms]
250ms   â”‚                              â”‚
        â”‚                              â”œâ”€ Audio done
        â”‚
300ms   â”‚                              â”œâ”€ Get "World" from queue
        â”‚                              â”œâ”€ Piper synthesizing...
350ms   â”‚                              â”‚
        â”‚                              â”œâ”€ Play audio [200-300ms]
400ms   â”‚                              â”‚
        â”‚                              â”œâ”€ Audio done
        â”‚
450ms   â”‚                              â”œâ”€ Get "Yes." from queue
        â”‚                              â”œâ”€ Piper synthesizing...
500ms   â”‚                              â”‚
        â”‚                              â”œâ”€ Play audio [400-500ms]
550ms   â”‚                              â”‚
        â”‚                              â”œâ”€ Audio done
        â”‚
600ms   â”‚                              â”œâ”€ Get None (poison pill)
        â”‚                              â””â”€ Exit
        â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ“ Main thread responsive during entire process
âœ“ Audio plays continuously
âœ“ No blocking, no asyncio, no RuntimeError!
```

## Queue States During Processing

### Initial State
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Empty Queue â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After send()
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Full Queue  â”‚
â”‚              â”‚
â”‚ [0] "Hello"  â”‚
â”‚ [1] "World"  â”‚
â”‚ [2] "Yes."   â”‚
â”‚ [3] None â˜ ï¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After processing "Hello"
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Partial     â”‚
â”‚              â”‚
â”‚ [0] "World"  â”‚
â”‚ [1] "Yes."   â”‚
â”‚ [2] None â˜ ï¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After processing "World"
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Partial     â”‚
â”‚              â”‚
â”‚ [0] "Yes."   â”‚
â”‚ [1] None â˜ ï¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After processing "Yes."
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Only Pill   â”‚
â”‚              â”‚
â”‚ [0] None â˜ ï¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After processing None (exit)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Empty Queue â”‚
â”‚              â”‚
â”‚ [Worker exits]
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Memory Diagram

```
Main Thread Stack          Worker Thread Stack         Shared Heap
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sink object     â”‚     â”‚ _worker()       â”‚     â”‚ Queue object â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚              â”‚
â”‚ .text_queue â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â†’ get()          â”‚     â”‚ [0] "Hello"  â”‚
â”‚ .worker_thread  â”‚     â”‚                 â”‚     â”‚ [1] "World"  â”‚
â”‚ .voice_path     â”‚     â”‚ text variable   â”‚     â”‚ [2] "Yes."   â”‚
â”‚ .piper_path     â”‚     â”‚                 â”‚     â”‚ [3] None     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ piper_process   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                 â”‚
                        â”‚ while loop:     â”‚
                        â”‚  - True         â”‚
                        â”‚  - True         â”‚
                        â”‚  - False (exit) â”‚
                        â”‚                 â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Prevention

### Before (RuntimeError Path) âŒ
```
sink.speak(text)
  â””â”€ send(text)
     â””â”€ asyncio.create_task()
        â””â”€ NO EVENT LOOP IN THREAD!
           â””â”€ RuntimeError âŒ
```

### After (Safe Path) âœ…
```
sink.speak(text)
  â””â”€ send(text)
     â””â”€ regex split
        â””â”€ queue.put(sentence)
           â””â”€ thread.Queue is thread-safe âœ“
              â””â”€ Returns immediately âœ“
```

## Summary

The queue-based architecture solves the RuntimeError by:

1. **Removing asyncio** - No event loop needed
2. **Using threading.Thread** - Proper thread model
3. **Using queue.Queue** - Thread-safe communication
4. **Decoupling producer/consumer** - LLM and TTS work independently

Result: âœ… TTS works perfectly in background thread!
